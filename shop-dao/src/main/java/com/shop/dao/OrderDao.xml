<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.shop.dao.OrderDao">

    <!--查询用户下的订单信息-->
    <resultMap type="userInfo" id="userAndOrdersAndOrderDetailAndItems">
        <id column="uId" property="uid"/>
        <result column="uName" property="uName"/>
        <result column="phone" property="phone"/>
        <result column="password" property="password"/>
        <result column="photo" property="photo"/>
        <!--        订单-->
        <collection property="orderInfo" ofType="OrderInfo">
            <id column="orderid" property="orderid"></id>
            <result column="uid" property="uid"></result>
            <result column="storeid" property="storeid"></result>
            <result column="orderTime" property="orderTime"/>
            <result column="receiptTime" property="receiptTime"/>
            <result column="state1" property="state1"/>
            <result column="state2" property="state2"/>
            <result column="state3" property="state3"/>
            <!--            订单商品-->
            <collection property="orderGoods" ofType="OrderGoods">
                <id column="id" property="id"></id>

                <result column="orderid" property="orderid"></result>
                <result column="number" property="number"/>
                <!--                商品-->
                <association property="commodity" javaType="Commodity">
                    <id column="cId" property="cId"/>
                    <result column="cName" property="cName"/>
                    <result column="tId" property="tId"/>
                    <result column="price" property="price"/>
                    <result column="picture" property="picture"/>

                    <result column="introduce" property="introduce"/>
                    <result column="state" property="state"/>

                    <result column="purchaseState" property="purchaseState"/>
                    <result column="purchasePrice" property="purchasePrice"/>
                </association>
            </collection>
        </collection>
    </resultMap>


    <select id="userOrderPage" resultMap="userAndOrdersAndOrderDetailAndItems" parameterType="userInfo">

        SELECT * FROM user_info u
        INNER JOIN order_info o ON u.uId = o.uid
        INNER JOIN order_goods od ON od.orderid = o.orderid
        INNER JOIN commodity c ON c.cId = od.goodsid
        <where>
            o.uId =  #{uid}
            <if test="state3!=null">and o.state3 = #{state3}</if>
        </where>
    </select>

    <select id="userOrderPageCount" resultType="int" parameterType="userInfo">

        SELECT COUNT(*) FROM user_info u
        INNER JOIN order_info o ON u.uId = o.uid
        INNER JOIN  order_goods od ON od.orderid = o.orderid
        INNER JOIN commodity c ON c.cId = od.goodsid
        <where>
            o.uId =  #{uid}
            <if test="state3!=null">and o.state3 = #{state3}</if>
        </where>
    </select>


    <!--    确认收货-->
    <update id="qdOrder">
        UPDATE `order_info`
            SET
              `state3` = #{state3}
            WHERE `orderid` = #{orderid} ;
    </update>

    <!-- —————————————————————————————————————————————————————————————————————————————————————————————————————————————————————— -->

    <resultMap id="queryAll" type="OrderInfo">
        <result property="storeid" column="storeid"></result>
        <result property="uid" column="uid"></result>
        <result property="orderid" column="orderid"></result>

        <!--        查询商户信息-->
        <collection property="storeInfo" ofType="storeInfo"
                    javaType="storeInfo" select="com.shop.dao.StoreDao.queryStoreById" column="storeid">

        </collection>
        <!--        查询用户信息-->
        <collection property="userInfo" ofType="userInfo"
                    javaType="userInfo" select="com.shop.dao.UserDao.queryUserInfo" column="uid"></collection>

        <!--        查询订单商品-->
        <collection property="orderGoods" ofType="orderGoods"
                    javaType="list" select="com.shop.dao.OrderGoods.queryAllOrderGoods" column="orderid"></collection>
    </resultMap>

    <!--    通过商户编号 查询商户订单-->
    <select id="queryAllOrderInfoBySid" parameterType="list" resultMap="queryAll">
        select * from Order_Info
         <where>
             storeid=#{order.storeid}
             <if test="time1 != null">
                 orderTime >= #{time1}
             </if>
             <if test="time2 != null">
                 #{time2} >= orderTime
             </if>
         </where>
    </select>

    <!--    查询商户订单总条数-->
    <select id="queryCountOrderInfoBySid" parameterType="OrderInfo" resultType="int">
        select count(*) from Order_Info
        <where>
            storeid=#{order.storeid}
            <if test="time1 != null">
                orderTime >= #{time1}
            </if>
            <if test="time2 != null">
                #{time2} >= orderTime
            </if>
        </where>
    </select>


</mapper>